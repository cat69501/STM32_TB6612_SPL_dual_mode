# STM32 双模式驱动控制系统

## 项目概述

本项目基于STM32F103C8T6微控制器，实现了**差速驱动**和**阿克曼转向**两种驱动模式的无缝切换控制系统。支持手动串口命令控制和自动模式切换。

## 🚗 驱动模式介绍

### 1. 差速驱动模式（坦克模式）
- **原理**: 通过左右两个电机的速度差实现转向
- **特点**: 
  - 可原地转弯，转弯半径为0
  - 精确控制，适合狭窄空间
  - 左转：左轮反转，右轮正转
  - 右转：左轮正转，右轮反转

### 2. 阿克曼转向模式（汽车模式）
- **原理**: 后轮驱动，前轮转向控制方向
- **特点**:
  - 自然转向，符合汽车驾驶习惯
  - 有最小转弯半径
  - 适合高速行驶和长距离移动
  - 转向更加平稳

## 🔧 硬件配置

### 引脚分配

| 功能 | 引脚 | 说明 |
|------|------|------|
| **电机A** | PA8 (PWM)<br>PB3/PB4 (方向) | 差速模式：左轮<br>阿克曼模式：后轮电机A |
| **电机B** | PA11 (PWM)<br>PB5/PB8 (方向) | 差速模式：右轮<br>阿克曼模式：后轮电机B（并联） |
| **舵机** | PA3 (TIM5_CH4) | 阿克曼模式前轮转向控制 |
| **编码器A** | PA6/PA7 (TIM3) | 电机A转速反馈 |
| **编码器B** | PA0/PA1 (TIM2) | 电机B转速反馈 |
| **串口** | PA9/PA10 (USART1) | 调试和控制命令 |
| **电压检测** | PA2 (ADC1_IN2) | 电源电压监测 |

### 电机驱动参数
- PWM频率：10kHz
- 速度范围：-7200 ~ +7200
- 正常速度：4000 (约55%功率)
- 转向速度：3000 (约42%功率)

### 舵机参数
- PWM频率：50Hz (20ms周期)
- 脉宽范围：500-2500μs
- 中位角度：90°
- 最大转向角度：45°

## 🎮 控制命令

### 串口配置
- 波特率：115200
- 数据位：8
- 停止位：1
- 校验位：无

### 命令列表

#### 模式切换
| 命令 | 功能 |
|------|------|
| `1` | 切换到差速驱动模式 |
| `2` | 切换到阿克曼转向模式 |

#### 运动控制
| 命令 | 功能 |
|------|------|
| `w` | 前进 |
| `s` | 后退 |
| `a` | 左转 |
| `d` | 右转 |
| `x` | 停止 |

#### 信息查询
| 命令 | 功能 |
|------|------|
| `h` | 显示帮助信息 |
| `i` | 显示当前状态信息 |

## 📁 文件结构

```
STM32_TB6612_SPL_final-3/
├── User/
│   ├── dual_mode_main.c          # 双模式控制主程序 ⭐
│   ├── ackermann_main.c          # 纯阿克曼模式程序
│   ├── differential_main.c       # 原差速模式程序
│   └── main.c                    # 当前编译的主程序
├── Driver/
│   ├── ax_motor.h/c              # 电机驱动
│   ├── ax_servo.h/c              # 舵机控制
│   ├── ax_uart.h/c               # 串口通信（已增强）
│   ├── ax_encoder.h/c            # 编码器驱动
│   └── ...
├── IO_ALLOCATION.md              # IO分配表
└── dual_mode_readme.md           # 本文档
```

## 🚀 使用方法

### 1. 编译下载
1. 将 `dual_mode_main.c` 重命名为 `main.c`（或在项目中指定为主文件）
2. 编译项目并下载到STM32F103C8T6
3. 连接串口工具（115200波特率）

### 2. 快速开始
1. 上电后，系统会显示欢迎信息和帮助
2. 发送 `1` 进入差速模式，或发送 `2` 进入阿克曼模式
3. 使用 `w/s/a/d/x` 控制运动
4. 发送 `h` 随时查看帮助，发送 `i` 查看状态

### 3. 示例操作流程
```
启动 → 发送'2'(阿克曼模式) → 发送'w'(前进) → 发送'a'(左转) → 发送'x'(停止)
```

## 📊 状态监控

系统每200ms输出一次状态信息：
```
[ACKERMANN:FORWARD] ENC_A: 123 ENC_B: 125 VIN:7.42V (手动模式)
```

状态信息包含：
- 当前模式：DIFFERENTIAL 或 ACKERMANN
- 当前动作：FORWARD/BACKWARD/TURN_LEFT/TURN_RIGHT/PAUSE
- 编码器数值：ENC_A 和 ENC_B
- 电源电压：VIN (单位：V)
- 控制方式：手动模式 或 自动切换

## ⚙️ 配置选项

### 模式切换方式
在 `dual_mode_main.c` 中修改：
```c
#define MODE_SWITCH_AUTO    0    // 0:手动切换  1:自动切换
```

- **手动切换模式** (推荐)：通过串口命令控制
- **自动切换模式**：每10秒自动切换模式，每3秒切换动作

### 速度参数调整
```c
#define MOTOR_SPEED_NORMAL    4000    // 正常速度
#define MOTOR_SPEED_TURN      3000    // 转向速度
#define MOTOR_SPEED_SLOW      2000    // 慢速
```

### 舵机角度调整
```c
#define SERVO_MAX_TURN_ANGLE  45      // 最大转向角度
```

## 🔍 故障排除

### 常见问题

1. **串口无输出**
   - 检查串口连接和波特率设置
   - 确认PA9/PA10引脚连接正确

2. **电机不转动**
   - 检查电机电源和驱动器连接
   - 确认PWM和方向控制引脚连接

3. **舵机不工作**
   - 检查PA3引脚连接和舵机电源
   - 确认舵机控制信号线连接正确

4. **编码器无数据**
   - 检查编码器电源和信号线
   - 确认编码器A/B相连接正确

### 调试技巧

1. 使用 `i` 命令查看实时状态
2. 观察编码器数值判断电机运行状态
3. 监控电压值确保电源供应正常
4. 通过串口输出信息分析问题

## 📈 扩展功能

### 可添加的功能
1. **遥控器控制**：集成PWM输入功能
2. **PID速度控制**：基于编码器反馈实现精确速度控制
3. **路径规划**：预设运动轨迹
4. **避障功能**：集成超声波或激光雷达
5. **无线控制**：添加WiFi或蓝牙模块

### 参数优化
1. 根据实际机械结构调整舵机角度范围
2. 根据电机特性调整PWM频率和速度参数
3. 根据应用场景优化动作持续时间

## 📝 版本历史

- **v1.0** - 实现双模式基础功能
- **v1.1** - 添加串口命令控制
- **v1.2** - 优化状态监控和错误处理

## 🤝 技术支持

如有问题或建议，请联系：
- 项目作者：Musk Han@XTARK
- 技术支持：www.xtark.cn

---

**注意**：使用前请仔细检查硬件连接，确保电源和信号线连接正确，避免损坏设备。